<!DOCTYPE html>
<html>
<head>
  <title>MPCE Forecasting Portal</title>
  <meta charset="utf-8" />
  <style>
    body {
      font-family: 'Poppins', 'Inter', 'Segoe UI', Arial, sans-serif !important;
      letter-spacing: 0.01em;
      margin: 0;
      padding: 0;
      background: linear-gradient(120deg, #e3eafc 0%, #f6fafd 100%);
      position: relative;
      overflow-x: hidden;
    }

    h2 {
      text-align: center;
      margin-top: 32px;
      margin-bottom: 16px;
      font-size: 2.5rem;
      color: #1a2a3a;
      letter-spacing: 1px;
      font-weight: 800;
      text-shadow: 0 2px 8px #e3eafc;
    }

    /* --- Form and Section Layout --- */
    .sector-form {
      max-width: 900px;
      margin: 44px auto;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(74,144,226,0.08);
      padding: 40px;
      text-align: center;
      animation: fadeInDown 0.7s;
      border: 2.5px solid #b5c8f7;
      background: none;
    }
    .sector-form h2 {
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 2.3rem;
      color: #222;
      font-weight: 800;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #e3eafc;
    }
    .sector-form label {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
      color: #222;
    }
    .radio-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 22px;
    }
    .radio-section h3 {
      margin: 0 0 14px 0;
      font-weight: 600;
      letter-spacing: 1px;
      color: #22223b;
    }
    .state-section {
      margin-bottom: 22px;
    }

    /* --- Capsule Controls (Year/Sector) --- */
    .capsule-control {
      display: flex;
      gap: 24px;
      margin-bottom: 18px;
    }
    .capsule-control input[type="checkbox"] {
      display: none;
    }
    .capsule-control label {
      padding: 12px 36px;
      border-radius: 999px;
      background: linear-gradient(90deg, #e0e7ff 0%, #c7d2fe 100%);
      color: #222;
      border: 2px solid #c7d2fe;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.08em;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
      transition: background 0.2s, color 0.2s, border 0.2s, box-shadow 0.2s, transform 0.1s;
      user-select: none;
      position: relative;
      letter-spacing: 1px;
    }
    .capsule-control label:hover {
      background: linear-gradient(270deg, #e0e7ff 0%, #c7d2fe 100%);
      color: #0078d7;
      border-color: #0078d7;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(0,120,215,0.10);
      transform: scale(1.1);
    }
    .capsule-control input[type="checkbox"]:checked + label {
      background: linear-gradient(90deg, #0078d7 0%, #005fa3 100%);
      color: #fff;
      border-color: #0078d7;
      font-weight: 700;
      box-shadow: 0 2px 12px rgba(0,120,215,0.18);
      z-index: 2;
      transform: scale(1.08);
    }

    /* --- Custom Radio (if used) --- */
    .custom-radio input[type="radio"] {
      display: none;
    }
    .custom-radio label {
      padding: 12px 36px;
      border-radius: 999px;
      background: linear-gradient(90deg, #e0e7ff 0%, #c7d2fe 100%);
      color: #222;
      border: 2px solid #c7d2fe;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.08em;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
      transition: background 0.2s, color 0.2s, border 0.2s, box-shadow 0.2s, transform 0.1s;
      user-select: none;
      position: relative;
      letter-spacing: 1px;
    }
    .custom-radio input[type="radio"]:checked + label {
      background: linear-gradient(90deg, #0078d7 0%, #005fa3 100%);
      color: #fff;
      border-color: #0078d7;
      font-weight: 700;
      box-shadow: 0 2px 12px rgba(0,120,215,0.18);
      z-index: 2;
      transform: scale(1.08);
      animation: pop 0.18s;
    }

    /* --- State Dropdown/Multiselect --- */
    .custom-multiselect {
      position: relative;
      width: 100%;
      max-width: 420px;
      margin: 10px 0 0 0;
      box-shadow: 0 2px 12px rgba(74,144,226,0.08);
      border-radius: 12px;
      background: #fff;
      transition: box-shadow 0.18s;
    }
    .dropdown-selected {
      background: #f0f4f8;
      border: 1.5px solid #c7d2fe;
      border-radius: 8px;
      padding: 12px 40px 12px 16px;
      cursor: pointer;
      min-height: 42px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      font-size: 1.05em;
      font-weight: 500;
      color: #22223b;
      transition: border 0.2s;
    }
    .dropdown-selected:hover, .dropdown-selected:focus {
      border-color: #0078d7;
    }
    .dropdown-arrow {
      position: absolute;
      right: 16px;
      pointer-events: none;
      font-size: 1.2em;
      color: #0078d7;
      font-weight: bold;
    }
    .dropdown-options {
      display: none;
      position: absolute;
      background: #fff;
      border: 1.5px solid #c7d2fe;
      border-radius: 0 0 8px 8px;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      box-shadow: 0 4px 16px rgba(0,0,0,0.10);
      font-size: 1.04em;
    }
    .dropdown-options.show {
      display: block;
    }
    .dropdown-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      border-bottom: 1px solid #f0f4f8;
      font-size: 1.07em;
      letter-spacing: 0.2px;
      border-radius: 6px;
      margin: 2px 4px;
    }
    .dropdown-option:last-child {
      border-bottom: none;
    }
    .dropdown-option:hover {
      background: #dbeafe;
      color: #005fa3;
      font-weight: 600;
    }

    /* --- Selected States Display --- */
    .selected-states-container {
      margin-top: 18px;
      text-align: left;
      border-radius: 10px;
      padding: 10px 14px;
      min-height: 48px;
      transition: background 0.18s;
      max-height: 120px;
      overflow-y: auto;
    }
    .selected-states-container h3 {
      margin: 0 0 8px 0;
      font-weight: 600;
      letter-spacing: 1px;
      color: #22223b;
    }
    #selectedStates {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .state-box {
      display: flex;
      align-items: center;
      background: linear-gradient(90deg, #e0e7ff 60%, #c7d2fe 100%);
      border: 1.5px solid #0078d7;
      color: #005fa3;
      font-weight: 600;
      font-size: 1.07em;
      border-radius: 18px;
      padding: 7px 18px 7px 14px;
      margin-bottom: 4px;
      margin-right: 6px;
      box-shadow: 0 1px 4px #e3eafc;
      transition: background 0.15s, color 0.15s, border 0.15s;
    }
    .state-box .remove-cross {
      margin-left: 10px;
      color: #d32f2f;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.15em;
      transition: color 0.15s;
    }
    .state-box .remove-cross:hover {
      color: #b71c1c;
    }

    /* --- Buttons --- */
    .sector-submit-btn {
      background: linear-gradient(90deg, #0078d7 60%, #005fa3 100%);
      color: #fff;
      border: none;
      padding: 12px 32px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 1.08rem;
      font-weight: 600;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(0,120,215,0.10);
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      margin-top: 18px;
      margin-bottom: 6px;
      font-size: 1.18rem;
      font-weight: 700;
      padding: 14px 44px;
    }
    .sector-submit-btn:active {
      transform: scale(0.97);
      box-shadow: 0 1px 4px #b5c8f7;
      animation: ripple 0.4s ease-in-out;
    }
    .sector-submit-btn:hover {
      background: linear-gradient(90deg, #0072ff 0%, #2196f3 100%);
      transform: scale(1.07);
    }
    .clear-selection-btn {
      background: #ff000050;
      color: #fff;
      font-weight: 700;
      border: none;
      padding: 12px 32px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 1.08rem;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(255,107,107,0.10);
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      outline: none;
      display: inline-block;
      margin-left: 20px;
      margin-right: auto;
    }
    .clear-selection-btn:hover {
      background: #ff000098;
      box-shadow: 0 4px 16px rgba(255,107,107,0.18);
      transform: translateY(-2px) scale(1.1);
    }
    .toggle-table-btn {
      background: linear-gradient(90deg, #0078d7 60%, #005fa3 100%);
      color: #fff;
      border: none;
      padding: 12px 32px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 1.08rem;
      font-weight: 700;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(0,120,215,0.10);
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s, right 0.3s, bottom 0.3s;
      margin-top: 18px;
      z-index: 1002;
      position: static;
    }
    .toggle-table-btn.floating {
      position: fixed !important;
      right: 32px;
      bottom: 32px;
      margin: 0 !important;
      box-shadow: 0 4px 24px rgba(0,120,215,0.18);
      animation: fadeIn 0.3s;
    }

    /* --- Table Styles --- */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 28px;
      background: #f8fafc;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
      font-size: 1.01em;
    }
    th {
      background: #e0e7ff;
      color: #22223b;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    tr:last-child td {
      border-bottom: none;
    }

    /* --- Map Container/Row --- */
    .main-container {
      max-width: 2000px;
      margin: 0 auto;
      padding: 24px 0 32px 0;
      animation: fadeInUp 0.7s;
    }
    .map-row {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      gap: 60px;
      margin-bottom: 48px;
      position: relative;
    }
    .map-row::after {
      content: '';
      position: absolute;
      left: 50%; top: 50%;
      width: 180px; height: 180px;
      background-image: url('data:image/svg+xml;utf8,<svg width="180" height="180" xmlns="http://www.w3.org/2000/svg"><rect x="30" y="30" width="120" height="120" rx="40" fill="%23e3eafc" /></svg>');
      opacity: 0.10;
      transform: translate(-50%, -50%);
      z-index: 0;
      pointer-events: none;
      animation: float3 16s ease-in-out infinite alternate;
    }
    .map-container {
      background: linear-gradient(120deg, #f6fafd 30%, #e3eafc 70%);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.10), 0 2px 8px rgba(0,0,0,0.07);
      padding: 30px 10px 10px 10px;
      margin-bottom: 0;
      position: relative;
      width: auto;
      max-width: 1300px;
      min-width: 340px;
      min-height: max-content;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 0;
      box-sizing: border-box;
      transition: box-shadow 0.2s;
    }
    .map-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: auto;
      min-width: 320px;
      position: relative;
      z-index: 1;
    }
    .map-title {
      text-align: center;
      font-weight: 700;
      font-size: 1.45rem;
      margin-bottom: 14px;
      color: #1a2a3a;
      letter-spacing: 0.5px;
      width: 100%;
      text-shadow: 0 1px 4px #e3eafc;
    }
    .map-svg {
      width: auto;
      height: auto;
      margin: 0px;
      display: block;
      border-radius: 12px;
      z-index: 4;
      animation: growFade 1s ease-in-out;
    }

    /* --- Map/Legend/Tooltip --- */
    .state {
      stroke: #000000;
      stroke-width: 1;
      transition: fill 0.2s;
      transition: fill 0.3s ease, transform 0.3s ease;
    }
    .state-selected {
      stroke-width: 1;
      stroke: #000;
    }
    .state-unselected {
      fill: #222;
      stroke-width: 1;
      stroke: #3a3a3a;
    }
    .legend-container {
      height: auto;
      margin-left: 12px;
      margin-top: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100px;
      user-select: none;
      z-index: 0;
      animation: growFade 1s ease-in-out;
    }
    .legend-label {
      font-size: 1.15rem;
      font-weight: 700;
      color: #133366;
      margin-bottom: 12px;
      text-align: center;
      letter-spacing: 0.5px;
      animation: growFade 1s ease-in-out;
    }
    .tooltip {
      position: fixed;
      background: #fff;
      border: 2px solid #4a90e2;
      padding: 10px 18px;
      border-radius: 10px;
      pointer-events: none;
      font-size: 17px;
      color: #1a2a3a;
      box-shadow: 0 4px 24px rgba(74,144,226,0.18);
      display: none;
      z-index: 5;
      min-width: 200px;
      font-weight: 500;
      letter-spacing: 0.2px;
      line-height: 1.5;
      animation: fadeIn 0.2s;
      transition: opacity 0.3s ease, transform 0.3s ease;
      transform: translateY(-6px);
    }
    .tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* --- Animation Keyframes --- */
    @keyframes growFade {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    @keyframes pop {
      0% { transform: scale(1);}
      60% { transform: scale(1.13);}
      100% { transform: scale(1.08);}
    }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-40px);}
      to { opacity: 1; transform: translateY(0);}
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px);}
      to { opacity: 1; transform: translateY(0);}
    }
    @keyframes fadeIn {
      from { opacity: 0;}
      to { opacity: 1;}
    }
    @keyframes float1 {
      0% { transform: translateY(0) scale(1);}
      100% { transform: translateY(40px) scale(1.08);}
    }
    @keyframes float2 {
      0% { transform: translateY(0) scale(1);}
      100% { transform: translateY(-30px) scale(1.04);}
    }
    @keyframes float3 {
      0% { transform: translate(-50%, -50%) scale(1);}
      100% { transform: translate(-50%, -54%) scale(1.07);}
    }

    /* --- Responsive --- */
    @media (max-width: 700px) {
      .toggle-table-btn.floating {
        right: 10px;
        bottom: 10px;
        padding: 10px 18px;
        font-size: 1rem;
      }
    }
    @media (max-width: 1100px) {
      .main-container { max-width: auto; }
      .map-row {
        display: flex;
        flex-direction: column;
        gap: 32px;
        margin-bottom: 0;
      }
      .map-container { max-width: max-content; }
      .map-content { width: auto; max-width: min-content; }
      .map-svg { width: auto; max-width: min-content; }
      .legend-container { height: auto; margin-left: 0; margin-top: 16px; }
    }
    @media (max-width: 900px) {
      .sector-form, .main-container, #selectionTableContainer {
        max-width: 98vw !important;
        padding: 10px 2vw !important;
      }
      .map-row {
        flex-direction: column;
        gap: 24px;
      }
    }
    .state-selected {
      stroke-width: 1;
      stroke: #000;
    }
    .state-unselected {
      fill: #222;
      stroke-width: 1;
      stroke: #3a3a3a;
    }
  </style>
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700&display=swap" rel="stylesheet">
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            mirror: false
        });
  </script>
  <form class="sector-form" id="sectorForm" onsubmit="return false;">
    <h2>ML Based National MPCE Forecasting Portal</h2>
    <div class="radio-section">
      <h3>Year</h3>
      <div class="capsule-control" id="yearCapsule">
        <input type="checkbox" name="year" id="year-2223" value="2223">
        <label for="year-2223">2022-23</label>
        <input type="checkbox" name="year" id="year-2324" value="2324">
        <label for="year-2324">2023-24</label>
        <!-- To add a new year, add a line like:
        <input type="checkbox" name="year" id="year-2526" value="2526">
        <label for="year-2526">2025-26</label>-->
      </div>
    </div>
    <div class="radio-section">
      <h3>Sector</h3>
        <div class="capsule-control" id="sectorCapsule">
          <input type="checkbox" name="sector" id="sector-rural" value="Rural">
          <label for="sector-rural">RURAL</label>
          <input type="checkbox" name="sector" id="sector-urban" value="Urban">
          <label for="sector-urban">URBAN</label>
        </div>
    </div>
    <div class="state-section">
      <label for="stateSelect" style="text-align: left;"><strong>Select States:</strong></label>
      <div class="state-select-container" style="display: flex; align-items: center; gap: 250px;">
        <div class="custom-multiselect" id="customMultiselect">
          <div class="dropdown-selected" id="dropdownSelected" onclick="toggleDropdown()">
            <span id="dropdownPlaceholder">Choose states...</span>
            <span class="dropdown-arrow">&#9662;</span>
          </div>
          <div class="dropdown-options" id="dropdownOptions"></div>
        </div>
        <button type="button" id="indiaMpceBtn" class="clear-selection-btn" style="display:none;" onclick="selectIndiaOnly()">India MPCE</button>
        <div id="clearSelectionContainer" style="display: none;">
          <button type="button" id="clearSelectionBtn" class="clear-selection-btn" onclick="clearSelection()">Clear Selection</button>
        </div>
      </div>
      <div class="selected-states-container">
        <h3>States</h3>
        <div id="selectedStates"></div>
      </div>
    </div>
    <button type="submit" class="sector-submit-btn">Submit</button>
  </form>
  <div class="main-container" id="mapsContainer" style="display:none;">
  </div>
  </div>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // Handles state/sector/year selection, dropdowns, table rendering, and D3 map rendering

    // --- State variables ---
    let allStates = [];
    let selectedStates = [];

    // --- Year config (automated) ---
    const YEAR_CONFIG = {
      '2223': { label: '2022-23', file: '/frontend/data/year_2022_23.csv' },
      '2324': { label: '2023-24', file: '/frontend/data/year_2023_24.csv' },
      // To add a new year, add a line like:
      // '2526': { label: '2025-26', file: '/frontend/data/year_2025_26.csv' }
    };

    // --- Year/Sector selection helpers ---
    function getSelectedYears() {
      return Array.from(document.querySelectorAll('input[name="year"]:checked')).map(cb => cb.value);
    }
    function getYearCSVFiles() {
      const years = getSelectedYears();
      return years
        .map(y => YEAR_CONFIG[y] ? { year: y, file: YEAR_CONFIG[y].file } : null)
        .filter(Boolean);
    }
    function getSelectedSectors() {
      const checked = Array.from(document.querySelectorAll('#sectorCapsule input[type="checkbox"]:checked'));
      return checked.map(cb => cb.value.toLowerCase());
    }
    function getSelectedYearLabel(year) {
      return YEAR_CONFIG[year] ? YEAR_CONFIG[year].label : '';
    }

    // --- State dropdown logic ---
    function populateStateDropdown(states) {
      const dropdownOptions = document.getElementById('dropdownOptions');
      if (!dropdownOptions) return;
      dropdownOptions.innerHTML = '';
      if (states.length > 0) {
        const allStatesOption = document.createElement('div');
        allStatesOption.className = 'dropdown-option';
        allStatesOption.textContent = 'All States';
        allStatesOption.onclick = function(e) {
          e.stopPropagation();
          selectedStates = ['All States'];
          updateSelectedStates();
          closeDropdown();
        };
        if (!selectedStates.includes('All States')) dropdownOptions.appendChild(allStatesOption);
        // Only show states that are not already selected and not "India"
        states.forEach(state => {
          if (
            !selectedStates.includes(state) &&
            !selectedStates.includes('All States') &&
            state.toLowerCase() !== 'india'
          ) {
            const option = document.createElement('div');
            option.className = 'dropdown-option';
            option.textContent = state;
            option.onclick = function(e) {
              e.stopPropagation();
              selectedStates = selectedStates.filter(s => s !== 'All States' && s !== 'India');
              if (!selectedStates.includes(state)) {
                selectedStates.push(state);
                updateSelectedStates();
              }
              closeDropdown();
            };
            dropdownOptions.appendChild(option);
          }
        });
        document.getElementById('dropdownPlaceholder').textContent = 'Choose states...';
      } else {
        document.getElementById('dropdownPlaceholder').textContent = 'Select year(s)';
      }
      // Show/hide India MPCE button
      showHideIndiaButton();
    }
    // Show or hide the India MPCE button based on selection
    function showHideIndiaButton() {
      const btn = document.getElementById('indiaMpceBtn');
      if (!btn) return;
      // Hide if any state is selected from dropdown (not India)
      if (selectedStates.length === 0) {
        btn.style.display = 'inline-block';
      } else {
        btn.style.display = 'none';
      }
    }
    // Update selected states UI and dropdown
    function updateSelectedStates() {
      const selectedStatesDiv = document.getElementById('selectedStates');
      selectedStatesDiv.innerHTML = '';
      selectedStates.forEach(state => {
        const box = document.createElement('div');
        box.className = 'state-box';
        box.textContent = state;
        const cross = document.createElement('span');
        cross.className = 'remove-cross';
        cross.textContent = '×';
        cross.onclick = function(e) {
          e.stopPropagation();
          selectedStates = selectedStates.filter(s => s !== state);
          updateSelectedStates();
          // Attach clear selection handler after DOM update
          attachClearSelectionHandler();
        };
        box.appendChild(cross);
        selectedStatesDiv.appendChild(box);
      });
      document.getElementById('dropdownPlaceholder').textContent = '';
      document.getElementById('clearSelectionContainer').style.display = selectedStates.length ? 'block' : 'none';
      // Do NOT call populateStateDropdown here to avoid recursion!
      showHideIndiaButton();
      // Attach clear selection handler after DOM update
      attachClearSelectionHandler();
    }
    // India MPCE button click handler
    function selectIndiaOnly() {
      selectedStates = ['India'];
      updateSelectedStates();
      closeDropdown();
      attachClearSelectionHandler();
    }
    window.selectIndiaOnly = selectIndiaOnly;
    // Load states from CSV for the selected year(s)
    function loadStatesFromCSV() {
      const yearFiles = getYearCSVFiles();
      const csvFile = yearFiles.length > 0 ? yearFiles[0].file : null;
      if (!csvFile) {
        allStates = [];
        populateStateDropdown([]);
        document.getElementById('dropdownPlaceholder').textContent = 'Select year first';
        return;
      }
      d3.csv(csvFile).then(data => {
        const stateList = [];
        data.forEach(d => {
          const state = d.StateName && d.StateName.trim();
          if (state && !stateList.includes(state)) stateList.push(state);
        });
        allStates = stateList;
        if (stateList.length > 0) {
          populateStateDropdown(allStates);
        } else {
          populateStateDropdown([]);
          document.getElementById('dropdownPlaceholder').textContent = 'Select year(s)';
        }
      }).catch(() => {
        allStates = [];
        populateStateDropdown([]);
        document.getElementById('dropdownPlaceholder').textContent = 'Select year(s)';
      });
    }

    // --- Table rendering ---
    function renderSelectionTable(sectors, states) {
      const containerId = 'selectionTableContainer';
      let container = document.getElementById(containerId);
      if (!sectors.length || !states.length) {
        if (container) container.innerHTML = '';
        return;
      }
      let useIndia = states.includes('India');
      const displayStates = (states.includes('All States'))
        ? allStates.filter(s => s.toLowerCase() !== 'india')
        : (useIndia ? ['India'] : states);
      if (!container) {
        container = document.createElement('div');
        container.id = containerId;
        container.style.margin = '32px auto 18px auto';
        container.style.maxWidth = '1000px';
        container.style.background = '#f6fafd';
        container.style.borderRadius = '16px';
        container.style.boxShadow = '0 2px 12px rgba(74,144,226,0.07)';
        container.style.padding = '18px 24px';
        container.style.fontSize = '1.12rem';
        container.style.fontWeight = '500';
        container.style.letterSpacing = '0.5px';
        container.style.textAlign = 'center';
        const mapsContainer = document.getElementById('mapsContainer');
        mapsContainer.parentNode.insertBefore(container, mapsContainer);
      }
      if (!displayStates.length) {
        container.innerHTML = '';
        return;
      }

      // Helper to get MPCE data for selected states/sectors/years
      function getMPCEDataFor(states, sectors, callback) {
        const yearFiles = getYearCSVFiles();
        if (!yearFiles.length) {
          callback([]);
          return;
        }
        // Load all selected years' data
        Promise.all(yearFiles.map(({ year, file }) =>
          d3.csv(file).then(data => ({ year, data }))
        )).then(yearDataArr => {
          // Build a flat array of {state, sector, year, actual, predicted}
          let rows = [];
          yearDataArr.forEach(({ year, data }) => {
            data.forEach(d => {
              const state = d.StateName && d.StateName.trim();
              const sector = d.SectorName && d.SectorName.trim().toLowerCase();
              if (
                state &&
                ((useIndia && state.toLowerCase() === 'india') ||
                  (!useIndia && states.includes(state)))
                && sectors.includes(sector)
              ) {
                rows.push({
                  state: useIndia ? 'India' : state,
                  sector: sector.charAt(0).toUpperCase() + sector.slice(1),
                  year: (year === '2223') ? '2022-23' : (year === '2324') ? '2023-24' : year,
                  actual: d.ActualMPCE,
                  predicted: d.PredictedMPCE
                });
              }
            });
          });
          callback(rows);
        }).catch(() => {
          callback([]);
        });
      }

      // Build HTML table for selection
      let html = '<table style="margin:0 auto; border-collapse:collapse; font-size:1.08rem;">';
      html += '<tr>';
      html += '<th style="padding:8px 18px; border-bottom:1.5px solid #b5c8f7;">State</th>';
      html += '<th style="padding:8px 18px; border-bottom:1.5px solid #b5c8f7;">Sector</th>';
      html += '<th style="padding:8px 18px; border-bottom:1.5px solid #b5c8f7;">Year</th>';
      html += '<th style="padding:8px 18px; border-bottom:1.5px solid #b5c8f7; text-align:center;">Actual MPCE (&#8377;)</th>';
      html += '<th style="padding:8px 18px; border-bottom:1.5px solid #b5c8f7; text-align:center;">Predicted MPCE (&#8377;)</th>';
      html += '<th style="padding:8px 18px; border-bottom:1.5px solid #b5c8f7; text-align:center;">Absolute Error (%)</th>';
      html += '</tr>';

      getMPCEDataFor(displayStates, sectors, function(rows) {
        if (!rows.length) {
          html += `<tr><td colspan="6" style="padding:12px; color:#d32f2f;">No data for selected states/sectors/years.</td></tr>`;
        } else {
          rows.forEach(row => {
            let errorPercent = '-';
            if (
              row.actual !== undefined && row.predicted !== undefined &&
              !isNaN(row.actual) && !isNaN(row.predicted) &&
              Number(row.actual) !== 0
            ) {
              errorPercent = ((Math.abs(Number(row.predicted) - Number(row.actual)) / Number(row.actual)) * 100).toFixed(2) + '%';
            }
            html += '<tr>';
            html += `<td style="padding:8px 18px; color:#0078d7;">${row.state}</td>`;
            html += `<td style="padding:8px 18px; color:#0078d7;">${row.sector}</td>`;
            html += `<td style="padding:8px 18px; color:#0078d7;">${row.year}</td>`;
            html += `<td style="padding:8px 18px; text-align:center;">${row.actual && !isNaN(row.actual) ? '₹ ' + Number(row.actual).toFixed(2) : '-'}</td>`;
            html += `<td style="padding:8px 18px; text-align:center;">${row.predicted && !isNaN(row.predicted) ? '₹ ' + Number(row.predicted).toFixed(2) : '-'}</td>`;
            html += `<td style="padding:8px 18px; text-align:center;">${errorPercent}</td>`;
            html += '</tr>';
          });
        }
        html += '</table>';
        container.innerHTML = html;
      });
    }

    // --- Map rendering ---
    function createDynamicMapContainers(selectedSectors) {
      let mapsContainer = document.getElementById('mapsContainer');
      if (!mapsContainer) {
        mapsContainer = document.createElement('div');
        mapsContainer.id = 'mapsContainer';
        mapsContainer.className = 'main-container';
        const formElem = document.getElementById('sectorForm');
        formElem.parentNode.insertBefore(mapsContainer, formElem.nextSibling);
      }
      mapsContainer.innerHTML = '';

      const yearFiles = getYearCSVFiles();
      const mapTypes = [
        { key: 'actual', label: 'Actual MPCE' },
        { key: 'predicted', label: 'Predicted MPCE' }
      ];

      // For each sector, for each year, create a row of maps
      selectedSectors.forEach(sector => {
        yearFiles.forEach(({ year }) => {
          const rowDiv = document.createElement('div');
          rowDiv.className = 'map-row';
          rowDiv.id = `row-${sector}-${year}`;

          mapTypes.forEach(type => {
            const containerDiv = document.createElement('div');
            containerDiv.className = 'map-container';
            containerDiv.id = `container-${type.key}-${sector}-${year}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'map-content';

            const titleDiv = document.createElement('div');
            titleDiv.className = 'map-title';
            titleDiv.textContent = `${type.label} (${sector.charAt(0).toUpperCase() + sector.slice(1)}) - ${getSelectedYearLabel(year)}`;

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.id = `map-${type.key}-${sector}-${year}`;
            svg.classList.add('map-svg');

            const tooltipDiv = document.createElement('div');
            tooltipDiv.id = `tooltip-${type.key}-${sector}-${year}`;
            tooltipDiv.className = 'tooltip';

            const legendDiv = document.createElement('div');
            legendDiv.className = 'legend-container';
            legendDiv.id = `legend-${type.key}-${sector}-${year}`;

            contentDiv.appendChild(titleDiv);
            contentDiv.appendChild(svg);
            contentDiv.appendChild(tooltipDiv);
            containerDiv.appendChild(contentDiv);
            containerDiv.appendChild(legendDiv);
            rowDiv.appendChild(containerDiv);
          });

          mapsContainer.appendChild(rowDiv);
        });
      });
    }
    function renderMPCEMaps(forceReload) {
      const width = 540, height = 620;
      const selectedSectors = getSelectedSectors();
      const yearFiles = getYearCSVFiles();
      const mapConfigs = [];

      // Build mapConfigs for all year/sector/type combinations
      selectedSectors.forEach(sector => {
        yearFiles.forEach(({ year }) => {
          mapConfigs.push(
            {
              svgId: `#map-actual-${sector}-${year}`,
              tooltipId: `#tooltip-actual-${sector}-${year}`,
              legendId: `#legend-actual-${sector}-${year}`,
              valueKey: sector === 'rural' ? 'ActualMPCE_Rural' : 'ActualMPCE_Urban',
              title: `Actual MPCE (${sector.charAt(0).toUpperCase() + sector.slice(1)}) - ${getSelectedYearLabel(year)}`,
              year,
            },
            {
              svgId: `#map-predicted-${sector}-${year}`,
              tooltipId: `#tooltip-predicted-${sector}-${year}`,
              legendId: `#legend-predicted-${sector}-${year}`,
              valueKey: sector === 'rural' ? 'PredictedMPCE_Rural' : 'PredictedMPCE_Urban',
              title: `Predicted MPCE (${sector.charAt(0).toUpperCase() + sector.slice(1)}) - ${getSelectedYearLabel(year)}`,
              year,
            }
          );
        });
      });

      const projection = d3.geoMercator()
        .center([80, 23])
        .scale(750)
        .translate([width / 2, height / 2]);
      const path = d3.geoPath().projection(projection);

      function normalizeStateName(name) {
        return name
          .toLowerCase()
          .replace(/[\s\.\&\(\)\-]/g, '');
      }

      function drawLegend(containerId, colorScale, minVal, maxVal) {
        const legendHeight = 340, legendWidth = 22;
        const legendSvg = d3.select(containerId)
          .html("")
          .append("svg")
          .attr("width", 90)
          .attr("height", legendHeight + 120);
        const defs = legendSvg.append("defs");
        const gradientId = containerId.replace("#", "") + "-gradient";
        const gradient = defs.append("linearGradient")
          .attr("id", gradientId)
          .attr("x1", "0%").attr("y1", "100%")
          .attr("x2", "0%").attr("y2", "0%");
        gradient.append("stop")
          .attr("offset", "0%")
          .attr("stop-color", colorScale(minVal));
        gradient.append("stop")
          .attr("offset", "100%")
          .attr("stop-color", colorScale(maxVal));
        legendSvg.append("rect")
          .attr("x", 34)
          .attr("y", 60)
          .attr("width", legendWidth)
          .attr("height", legendHeight)
          .style("fill", `url(#${gradientId})`)
          .style("stroke", "#333")
          .style("stroke-width", "1");
        legendSvg.append("text")
          .attr("x", 34 + legendWidth / 2)
          .attr("y", 60 + legendHeight + 28)
          .attr("text-anchor", "middle")
          .attr("font-size", "18px")
          .attr("fill", "#133366")
          .attr("font-weight", "bold")
          .text(minVal);
        legendSvg.append("text")
          .attr("x", 34 + legendWidth / 2)
          .attr("y", 52)
          .attr("text-anchor", "middle")
          .attr("font-size", "18px")
          .attr("fill", "#133366")
          .attr("font-weight", "bold")
          .text(maxVal);
        legendSvg.append("text")
          .attr("x", 34 + legendWidth / 2)
          .attr("y", 28)
          .attr("text-anchor", "middle")
          .attr("font-size", "17px")
          .attr("font-weight", "bold")
          .attr("fill", "#133366")
          .text("MPCE");
      }

      function loadAndRenderMaps() {
        // For each year, load its CSV and render all maps for that year
        const useIndia = selectedStates.includes('India');
        yearFiles.forEach(({ year, file }) => {
          const geojsonFile = useIndia ? '/frontend/data/india-composite.geojson' : '/frontend/data/india.json';
          d3.json(geojsonFile).then(geojson => {
            d3.csv(file).then(csvData => {
              let dataByState = {};
              csvData.forEach(d => {
                const normState = normalizeStateName(d.StateName.trim());
                if (!dataByState[normState]) {
                  dataByState[normState] = { csvStateName: d.StateName.trim() };
                }
                if (d.SectorName.trim().toLowerCase() === "rural") {
                  dataByState[normState].ActualMPCE_Rural = +d.ActualMPCE;
                  dataByState[normState].PredictedMPCE_Rural = +d.PredictedMPCE;
                } else if (d.SectorName.trim().toLowerCase() === "urban") {
                  dataByState[normState].ActualMPCE_Urban = +d.ActualMPCE;
                  dataByState[normState].PredictedMPCE_Urban = +d.PredictedMPCE;
                }
              });
              const allValues = [];
              Object.values(dataByState).forEach(d => {
                ["ActualMPCE_Rural", "ActualMPCE_Urban", "PredictedMPCE_Rural", "PredictedMPCE_Urban"].forEach(key => {
                  if (d[key] !== undefined && !isNaN(d[key])) allValues.push(d[key]);
                });
              });
              const minVal = Math.floor(d3.min(allValues)/ 100) * 100;
              const maxVal = Math.ceil(d3.max(allValues)  / 100) * 100;
              const colorScale = d3.scaleLinear()
                .domain([minVal, maxVal])
                .range(["#fefded", "#ff0000"]);
              const selected = useIndia
                ? ['India']
                : (selectedStates.includes('All States') || selectedStates.length === 0)
                  ? Object.values(dataByState).map(d => d.csvStateName)
                  : selectedStates;
              function isStateSelected(stateName) {
                if (useIndia) return stateName.trim().toLowerCase() === 'india';
                const norm = normalizeStateName(stateName);
                return selected.some(sel => normalizeStateName(sel) === norm);
              }
              // Render all mapConfigs for this year
              mapConfigs.filter(cfg => cfg.year === year).forEach(cfg => {
                drawLegend(cfg.legendId, colorScale, minVal, maxVal);
                const svg = d3.select(cfg.svgId)
                  .attr("width", width)
                  .attr("height", height);
                const tooltip = d3.select(cfg.tooltipId);
                svg.selectAll("path")
                  .data(geojson.features)
                  .enter().append("path")
                  .attr("class", function(d) {
                    const geoState = (d.properties.st_nm || "Unknown");
                    return isStateSelected(geoState) ? "state state-selected" : "state state-unselected";
                  })
                  .attr("d", path)
                  .attr("fill", function(d) {
                    const geoState = (d.properties.st_nm || "Unknown");
                    const normGeoState = normalizeStateName(geoState);
                    const stateData = dataByState[normGeoState];
                    let value = stateData ? stateData[cfg.valueKey] : undefined;
                    if (isStateSelected(geoState)) {
                      return (value !== undefined && !isNaN(value)) ? colorScale(value) : "#eee";
                    } else {
                      return "#f2f2f2";
                    }
                  })
                  .attr("opacity", function(d) {
                    const geoState = (d.properties.st_nm || "Unknown");
                    return isStateSelected(geoState) ? 1 : 0.35;
                  })
                  .on("mouseover", function(event, d) {
                    const geoState = (d.properties.st_nm || "Unknown");
                    const normGeoState = normalizeStateName(geoState);
                    const stateData = dataByState[normGeoState];
                    let value = stateData ? stateData[cfg.valueKey] : "N/A";
                    let displayName = stateData ? stateData.csvStateName : geoState;
                    let valueDisplay = (value !== undefined && !isNaN(value)) ? `₹ ${Number(value).toFixed(2)}` : value;
                    tooltip
                      .style("display", "block")
                      .html(
                        `<strong>${displayName}</strong><br/>` +
                        `${cfg.title}: <b>${valueDisplay}</b>`
                      );
                  })
                  .on("mousemove", function(event) {
                    tooltip
                      .style("left", (event.clientX + 20) + "px")
                      .style("top", (event.clientY - 10) + "px");
                  })
                  .on("mouseout", function() {
                    tooltip.style("display", "none");
                  });
              });
            });
          });
        });
      }

      if (forceReload) {
        loadAndRenderMaps();
        return;
      }
      loadAndRenderMaps();
    }

    // --- Event handlers and UI logic ---
    document.querySelectorAll('input[name="year"]').forEach(cb => {
      cb.addEventListener('change', function() {
        updateSelectedStates();
        loadStatesFromCSV();
        // After loading states, repopulate dropdown
        setTimeout(() => {
          populateStateDropdown(allStates);
          attachClearSelectionHandler();
        }, 0);
        showHideIndiaButton();
      });
    });
    loadStatesFromCSV();
    setTimeout(() => {
      populateStateDropdown(allStates);
      attachClearSelectionHandler();
    }, 0);

    document.getElementById('sectorForm').onsubmit = function() {
      const selectedYears = getSelectedYears();
      const selectedSectors = getSelectedSectors();
      const errorMsgId = 'selectionErrorMsg';
      let errorMsg = '';
      if (selectedYears.length === 0) {
        errorMsg = 'Please select at least one year.';
      } else if (!selectedSectors.length && !selectedStates.length) {
        errorMsg = 'Please select at least one sector and one state.';
      } else if (!selectedSectors.length) {
        errorMsg = 'Please select at least one sector.';
      } else if (!selectedStates.length) {
        errorMsg = 'Please select at least one state.';
      }
      let errorElem = document.getElementById(errorMsgId);
      if (!errorElem) {
        errorElem = document.createElement('div');
        errorElem.id = errorMsgId;
        errorElem.style.color = '#d32f2f';
        errorElem.style.fontWeight = '600';
        errorElem.style.margin = '12px 0 0 0';
        errorElem.style.fontSize = '1.08rem';
        const form = document.getElementById('sectorForm');
        form.insertBefore(errorElem, form.querySelector('.sector-submit-btn'));
      }
      errorElem.textContent = errorMsg;
      if (errorMsg) return false;
      errorElem.textContent = '';
      // For table, just use the first selected year
      renderSelectionTable(selectedSectors, selectedStates);
      document.getElementById('mapsContainer').style.display = 'block';
      createDynamicMapContainers(selectedSectors);
      if (typeof renderMPCEMaps === "function") renderMPCEMaps(true);
      setTimeout(() => {
        const mapsElem = document.getElementById('mapsContainer');
        if (mapsElem) mapsElem.scrollIntoView({ behavior: 'smooth' });
      }, 50);
      return false;
    };

    // --- Utility functions ---
    function attachClearSelectionHandler() {
      const clearBtn = document.getElementById('clearSelectionBtn');
      if (clearBtn && !clearBtn._handlerAttached) {
        clearBtn.onclick = function(e) {
          e.stopPropagation();
          selectedStates = [];
          updateSelectedStates();
          closeDropdown();
          attachClearSelectionHandler();
        };
        clearBtn._handlerAttached = true;
      }
    }
    attachClearSelectionHandler();
    document.addEventListener('DOMContentLoaded', attachClearSelectionHandler);
    const observer = new MutationObserver(attachClearSelectionHandler);
    observer.observe(document.body, { childList: true, subtree: true });

    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownOptions');
      dropdown.classList.toggle('show');
    }
    window.toggleDropdown = toggleDropdown;

    function closeDropdown() {
      const dropdown = document.getElementById('dropdownOptions');
      if (dropdown) dropdown.classList.remove('show');
    }
    window.closeDropdown = closeDropdown;
  </script>
</body>
</html>